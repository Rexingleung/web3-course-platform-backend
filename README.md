# Web3 Course Platform - Backend\n\n这是一个基于智能合约的课程平台后端服务，使用 Node.js + Express + TypeScript + MySQL 构建。\n\n## 功能特性\n\n- 🔗 与智能合约集成，同步课程数据\n- 📊 用户购买课程记录\n- 🎓 课程管理和查询\n- 👨‍🏫 作者课程管理\n- 🗄️ MySQL 数据库存储\n- 🚀 RESTful API 接口\n- 🔄 智能合约故障转移（数据库后备）\n\n## 技术栈\n\n- Node.js + Express\n- TypeScript\n- MySQL2\n- Ethers.js (Web3)\n- CORS\n\n## 快速开始\n\n### 环境要求\n\n- Node.js 16+\n- MySQL 5.7+\n- 智能合约已部署（可选，有数据库后备）\n\n### 1. 安装依赖\n\n```bash\nnpm install\n```\n\n### 2. 环境配置\n\n复制 `.env.example` 为 `.env` 并配置：\n\n```env\nPORT=3001\nDB_HOST=localhost\nDB_USER=root\nDB_PASSWORD=&*&Ddasd123.ii2\nDB_NAME=web3\nCONTRACT_ADDRESS=0xdDD30BD07C402eE78079c35A7DE2F9232ed54Aa4\nRPC_URL=http://localhost:8545\n```\n\n### 3. 数据库初始化和种子数据\n\n**选项 A: 完整设置（推荐）**\n```bash\nnpm run setup\n```\n\n**选项 B: 分步骤设置**\n```bash\n# 创建数据库表\nnpm run migrate\n\n# 插入测试数据\nnpm run seed\n```\n\n### 4. 启动开发服务器\n\n```bash\nnpm run dev\n```\n\n服务将运行在 http://localhost:3001\n\n### 5. 构建生产版本\n\n```bash\nnpm run build\nnpm start\n```\n\n## API 接口\n\n### 课程相关\n\n- `GET /api/courses` - 获取所有课程\n- `GET /api/courses/:id` - 获取指定课程\n- `GET /api/courses/count` - 获取课程总数\n- `GET /api/courses/author/:author` - 获取作者的课程\n- `POST /api/courses/sync` - 同步智能合约数据\n\n### 购买相关\n\n- `GET /api/courses/purchased/:userAddress` - 获取用户购买的课程\n- `GET /api/courses/purchased/:courseId/:userAddress` - 检查购买状态\n- `POST /api/courses/purchase` - 记录购买交易\n\n### 健康检查\n\n- `GET /health` - 服务状态检查\n\n## 智能合约集成\n\n后端服务通过 ethers.js 与智能合约交互：\n\n- 合约地址：`0xdDD30BD07C402eE78079c35A7DE2F9232ed54Aa4`\n- 支持读取课程信息\n- 支持查询用户购买记录\n- 自动同步合约数据到数据库\n- **智能故障转移**：如果合约不可用，自动使用数据库后备\n\n## 测试数据\n\n运行 `npm run seed` 后，系统会插入以下测试数据：\n\n### 示例课程\n1. **Web3 开发入门** - 0.1 ETH\n2. **DeFi 协议深度解析** - 0.2 ETH  \n3. **NFT 市场开发实战** - 0.15 ETH\n4. **Solidity 高级编程技巧** - 0.25 ETH\n5. **Layer 2 扩容方案详解** - 0.18 ETH\n\n### 示例用户地址\n- `0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266`\n- `0x70997970C51812dc3A010C7d01b50e0d17dc79C8`\n- `0x742d35Cc6634C0532925a3b8D65aEd2934C12D5e`\n\n## 故障排除\n\n### 常见问题\n\n1. **数据库连接失败**\n   ```bash\n   # 检查 MySQL 服务状态\n   sudo systemctl status mysql\n   \n   # 启动 MySQL（如需要）\n   sudo systemctl start mysql\n   ```\n\n2. **\"Database not initialized\" 错误**\n   ```bash\n   # 重新运行迁移\n   npm run migrate\n   ```\n\n3. **智能合约连接失败**\n   - 系统会自动使用数据库后备\n   - 检查 RPC_URL 配置\n   - 验证合约地址\n\n### 测试 API 端点\n\n```bash\n# 获取所有课程\ncurl http://localhost:3001/api/courses\n\n# 获取特定用户的已购课程\ncurl http://localhost:3001/api/courses/purchased/0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266\n\n# 健康检查\ncurl http://localhost:3001/health\n```\n\n## 数据库结构\n\n### courses 表\n\n- `id` - 自增主键\n- `course_id` - 智能合约中的课程ID\n- `title` - 课程标题\n- `description` - 课程描述\n- `author` - 作者地址\n- `price` - 课程价格（wei）\n- `created_at` - 创建时间戳\n- `updated_at` - 更新时间\n\n### purchases 表\n\n- `id` - 自增主键\n- `course_id` - 课程ID\n- `buyer` - 购买者地址\n- `price` - 购买价格\n- `transaction_hash` - 交易哈希\n- `purchased_at` - 购买时间\n\n## 开发说明\n\n### 项目结构\n\n```\nsrc/\n├── controllers/     # 控制器\n├── services/       # 业务逻辑服务\n├── routes/         # 路由配置\n├── database/       # 数据库配置\n│   ├── connection.ts  # 数据库连接\n│   ├── migrate.ts     # 数据库迁移\n│   └── seed.ts        # 测试数据\n├── contracts/      # 智能合约交互\n├── types/          # TypeScript 类型定义\n└── index.ts        # 应用入口\n```\n\n### 脚本命令\n\n- `npm run dev` - 开发模式运行\n- `npm run build` - 构建项目\n- `npm start` - 生产模式运行\n- `npm run migrate` - 数据库迁移\n- `npm run seed` - 插入测试数据\n- `npm run setup` - 完整初始化（迁移+种子数据）\n\n## 部署指南\n\n### Docker 部署\n\n```dockerfile\nFROM node:16-alpine\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci --only=production\nCOPY . .\nRUN npm run build\nEXPOSE 3001\nCMD [\"npm\", \"start\"]\n```\n\n### 环境变量\n\n确保生产环境配置正确的环境变量：\n\n- `PORT` - 服务端口\n- `DB_HOST` - 数据库主机\n- `DB_USER` - 数据库用户\n- `DB_PASSWORD` - 数据库密码\n- `DB_NAME` - 数据库名称\n- `CONTRACT_ADDRESS` - 智能合约地址\n- `RPC_URL` - 区块链RPC地址\n\n## 架构特点\n\n### 智能故障转移\n\n系统设计了智能的故障转移机制：\n\n1. **优先使用智能合约**：所有数据查询首先尝试从智能合约获取\n2. **自动数据库后备**：当合约不可用时，自动切换到数据库查询\n3. **数据同步**：合约可用时自动同步数据到数据库\n4. **无缝切换**：前端无需感知数据源变化\n\n### 性能优化\n\n- 数据库连接池\n- 合约调用缓存\n- 错误重试机制\n- 连接状态监控\n\n## 安全建议\n\n- 使用环境变量存储敏感信息\n- 启用 HTTPS\n- 实施API速率限制\n- 定期更新依赖包\n- 监控系统资源使用\n\n## 贡献指南\n\n1. Fork 项目\n2. 创建功能分支\n3. 提交更改\n4. 推送到分支\n5. 创建 Pull Request\n\n## 许可证\n\nMIT License"